<tal:block metal:use-macro="context/quickstart_macros/base">

    <tal:block metal:fill-slot="headline"> 
    Step 1: Set Up Initial Users
    </tal:block>

    <tal:block metal:fill-slot="subheadline">
    </tal:block>

    <tal:block metal:fill-slot="content">
        <div id="newform">
        </div>

        <!--Hidden form for logging in as the new user. This is basically the
            same form you'll find on the main login page, only we set the value
            of the fields via javascript once we get notification of successful
            user creation from the server.                                  -->
        <form id="loginform" method="POST" 
                action="/zport/acl_users/cookieAuthHelper/login">
            <input type="hidden" name="came_from" id="came_from"
                tal:attributes="value here/absolute_url_path"/>
            <input id="login_username" type="hidden" name="__ac_name" />
            <input type="hidden" id="login_password" name="__ac_password"/>
        </form>

    </tal:block>

    <tal:block metal:fill-slot="buttons">
    </tal:block>

    <script type="text/javascript" metal:fill-slot="extra-scripts">
    Ext.onReady(function() {

        Ext.QuickTips.init();

        Ext.form.Field.prototype.msgTarget = 'side';

        Ext.apply(Ext.form.VTypes, {
            password: function(val, field) {
                if (field.initialPassField) {
                    var pwd = Ext.getCmp(field.initialPassField);
                    return (val == pwd.getValue());
                }
            },
            passwordText: "The passwords you've typed don't match."
        });

        var userform = new Ext.FormPanel({
            labelWidth: 100,
            frame: false,
            border: false,
            bodyStyle: 'padding:5px 5px 0',
            width:'100%',
            layout: 'column',
            defaults: {autoHeight:true, columnWidth:0.5, 
                layout:'form', frame:false, border:false},
            items: [{ // 50% column
                items:[
                        // Admin password fields
                       new Ext.form.FieldSet({
                        border: false,
                        anchor:'100%',
                        layout:'form',
                        defaults: {width: 175},
                        defaultType: 'textfield',
                        title: "Set admin password",
                        autoHeight: true,
                        items: [{
                            fieldLabel: 'Admin password',
                            inputType: 'password',
                            name: 'admin-password1',
                            id: 'admin-password1',
                            allowBlank: false
                        },{
                            fieldLabel: 'Retype password',
                            inputType: 'password',
                            vtype: 'password',
                            name: 'admin-password2',
                            initialPassField: 'admin-password1',
                            allowBlank: false
                        }],
                    })
                ]
            },{ // 50% column
                items:[
                    // New user fields
                    new Ext.form.FieldSet({
                        border: false,
                        anchor:'100%',
                        layout:'form',
                        id: 'userfieldset',
                        defaults: {width: 175},
                        defaultType: 'textfield',
                        title: "Create your account",
                        autoHeight: true,
                        items: [{
                            id: 'username',
                            fieldLabel: 'User name',
                            name: 'username',
                            allowBlank: false
                        },{
                            fieldLabel: 'Password',
                            inputType: 'password',
                            name: 'password1',
                            id: 'password1',
                            allowBlank: false
                        },{
                            fieldLabel: 'Retype password',
                            inputType: 'password',
                            vtype: 'password',
                            name: 'password2',
                            initialPassField: 'password1',
                            allowBlank: false
                        },{
                            fieldLabel: 'Your email',
                            vtype: 'email',
                            name: 'emailAddress',
                            allowBlank: true
                        }],
                    })
                ]
            }]
        });

        var submit = userform.addButton({
            text: 'Submit',
            handler: function() {
                userform.getForm().submit({url:'qs-createuser'})
            }
        })

        function logInAsNewUserAndRedirectTo(url) {
            Ext.get('login_username').dom.value = Ext.getCmp(
                'username').getValue();
            Ext.get('login_password').dom.value = Ext.getCmp(
                'password1').getValue();
            Ext.get('came_from').dom.value += '/'+url;
            Ext.get('loginform').dom.submit();
        }

        userform.render('newform');
        userform.on({'actioncomplete':
            function(form, action) {
                var url = action.result.redirect;
                if (url && action.result.success)  
                    logInAsNewUserAndRedirectTo(url);
            }
        });

    });
    </script>

</tal:block>
