#! /usr/bin/env bash

#
# zenoss_init_pre
#
# This script is intended to be run before the zenoss processes have
# been started for the first time.
#

# environment variables
export OS_USERNAME="**OS_USERNAME**"
export ZENHOME="**ZENHOME**"
export MYSQLHOST="**MYSQL_HOST**"
export MYSQLUSER="**MYSQL_USERNAME**"
export MYSQLPASS="**MYSQL_PASSWD**"
export MYSQLEVENTDB="**MYSQL_DATABASE**"
export ZOPEPASSWORD="**ZOPE_PASSWD**"
export ZOPEHOME=${ZENHOME}

# load the installation functions
. ${ZENHOME}/bin/shared-functions.sh
. ${ZENHOME}/bin/install-functions.sh

# create the log directory
mkdir -p ${ZENHOME}/log

# restart external server daemons
restart_snmpd
restart_mysql

# copy the etc/*.conf.example files to etc/*.conf if etc/*.conf don't
# already exist (we don't want to clobber people's configs)
update_conf_files

# create the events mysql database
create_database

# populate the events database
run_zeneventbuild

# set up the zope instance
run_mkzopeinstance

# create the zeodb instance
run_mkzeoinstance

# create the zeo database
start_zeodb
sudo chown -R ${OS_USERNAME} ${ZENHOME}/var
run_zenbuild
stop_zeodb
