#!/bin/sh

#
# zenoss_init      A script that performs the initialization required for zenoss
#
# description: Zenoss is a monitoring program written by Zenoss, Inc.

# environment variables
export RUNUSER="**OS_USERNAME**"
export ZENHOME="**ZENHOME**"
export MYSQL_USERNAME="**MYSQL_USERNAME**"
export MYSQL_PASSWD="**MYSQL_PASSWD**"
export ZOPE_PASSWD="**ZOPE_PASSWD**"
export SNMPD_CONF="**SNMPD_CONF**"
export SUDOERS="**SUDOERS**"


# location of where we copy configuration items to
ZEN_ETC=${ZENHOME}/etc

# update the sudoers file
SUDOERS=/etc/sudoers
BACKUP=`dirname ${SUDOERS}`/`basename ${SUDOERS}`.orig
sudo cp ${SUDOERS} ${BACKUP}
sudo cp ${ZEN_ETC}/sudoers ${SUDOERS}

# update the snmpd.conf file
SNMPD_CONF_DIR=`dirname ${SNMPD_CONF}`
BACKUP=${SNMPD_CONF_DIR}/`basename ${SNMPD_CONF}`.orig
if [ -f ${SNMPD_CONF} ]; then
    sudo cp ${SNMPD_CONF} ${BACKUP}
fi
if [ ! -d ${SNMPD_CONF_DIR} ]; then
    sudo mkdir -p ${SNMPD_CONF_DIR}
fi
sudo cp ${ZEN_ETC}/snmpd.conf ${SNMPD_CONF}

# grant permissions to the events database
if mysql -u root </dev/null >/dev/null 2>/dev/null
then
   mysql -u root <<EOF
  create database events;
	grant all on events.* to '${MYSQL_USERNAME}'@'localhost' identified by '${MYSQL_PASSWD}';
	grant super, file on *.* to '${MYSQL_USERNAME}'@'localhost'; 
	flush privileges;
EOF
fi

# create the log directory
mkdir -p ${ZENHOME}/log

# create the events database in mysql
if mysql events -u ${MYSQL_USERNAME} -p"${MYSQL_PASSWD}" -e 'quit' 2>/dev/null ; 
then
   ${ZENHOME}/bin/zeneventbuild ${MYSQL_USERNAME} ${MYSQL_PASSWD}
fi

# set up the zope instance and the zeo database
python ${ZENHOME}/bin/mkzopeinstance.py \
    --dir="$ZENHOME" \
    --user="admin:${ZOPE_PASSWD}"
mv ${ZENHOME}/etc/zenoss.conf $ZENHOME/etc/zope.conf
python ${ZENHOME}/bin/mkzeoinstance.py $ZENHOME

# chown the files to be owned by zenoss
sudo chown -R ${RUNUSER} ${ZENHOME}
sudo chgrp -R wheel ${ZENHOME}
sudo chmod -R 775 ${ZENHOME}


# create the zeo database
${ZENHOME}/bin/zeoctl start
sudo chown -R ${RUNUSER} ${ZENHOME}/var
sudo -u ${RUNUSER} -i ${ZENHOME}/bin/zenbuild -u ${MYSQL_USERNAME} -p "${MYSQL_PASSWD}" 
${ZENHOME}/bin/zeoctl stop
