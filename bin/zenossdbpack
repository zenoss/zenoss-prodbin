#!/usr/bin/env python
import sys
import tempfile
import optparse
import subprocess

import Globals
from Products.ZenUtils.Utils import zenPath
from Products.ZenUtils.GlobalConfig import getGlobalConfiguration

CONFIG = """
<relstorage>
    pack-gc true
    pack-duty-cycle 0.9
    keep-history false
    <mysql>
        host %(host)s
        port %(port)s
        db %(mysqldb)s
        user %(mysqluser)s
        passwd %(mysqlpasswd)s
    </mysql>
</relstorage>
""" % getGlobalConfiguration()

if __name__=="__main__":
    # Get the days option to forward to zodbpack
    parser = optparse.OptionParser(description=__doc__,
        usage="%prog [options]")
    parser.add_option( "-d", "--days", dest="days", default="0",
                      help="Days of history to keep (default 0)")
    options, args = parser.parse_args(sys.argv[1:])

    retcode = 1

    # Write the config file and call zodbpack
    with tempfile.NamedTemporaryFile() as configfile:
        configfile.write(CONFIG)
        cmd = [zenPath('bin', 'zodbpack'), configfile.name, '-d', options.days]
        retcode = subprocess.call(cmd)

    sys.exit(retcode)
