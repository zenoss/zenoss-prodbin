#! /usr/bin/env bash

#
# zenoss_init      A script that performs the initialization required for zenoss
#
# description: Zenoss is a monitoring program written by Zenoss, Inc.

# environment variables
export RUNUSER="**OS_USERNAME**"
export ZENHOME="**ZENHOME**"
export MYSQL_USERNAME="**MYSQL_USERNAME**"
export MYSQL_PASSWD="**MYSQL_PASSWD**"
export MYSQL_DATABASE="**MYSQL_DATABASE**"
export ZOPE_PASSWD="**ZOPE_PASSWD**"


# create the log directory
mkdir -p ${ZENHOME}/log

# grant permissions to the events database
if mysql -u root </dev/null >/dev/null 2>/dev/null
then
   mysql -u root <<EOF
  create database events;
	grant all on events.* to '${MYSQL_USERNAME}'@'localhost' identified by '${MYSQL_PASSWD}';
	grant super, file on *.* to '${MYSQL_USERNAME}'@'localhost'; 
	flush privileges;
EOF
fi

# create the events database in mysql
if mysql ${MYSQL_DATABASE} -u ${MYSQL_USERNAME} -p"${MYSQL_PASSWD}" -e 'quit' 2>/dev/null ; 
then
   ${ZENHOME}/bin/zeneventbuild ${MYSQL_USERNAME} ${MYSQL_PASSWD} ${MYSQL_DATABASE}
fi

# set up the zope instance and the zeo database
python ${ZENHOME}/bin/mkzopeinstance.py \
    --dir="$ZENHOME" \
    --user="admin:${ZOPE_PASSWD}"
mv ${ZENHOME}/etc/zenoss.conf $ZENHOME/etc/zope.conf
python ${ZENHOME}/bin/mkzeoinstance.py $ZENHOME

# create the zeo database
${ZENHOME}/bin/zeoctl start
sudo chown -R ${RUNUSER} ${ZENHOME}/var
sudo -u ${RUNUSER} ${ZENHOME}/bin/zenbuild -u ${MYSQL_USERNAME} -p "${MYSQL_PASSWD}" 
${ZENHOME}/bin/zeoctl stop
