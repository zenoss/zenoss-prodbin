#! /usr/bin/env bash
#############################################################################
# This program is part of Zenoss Core, an open source monitoring platform.
# Copyright (C) 2010, Zenoss Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 as published by
# the Free Software Foundation.
#
# For complete information please visit: http://www.zenoss.com/oss/
#############################################################################

if [ -z "$ZENHOME" ] ; then
    echo ERROR: '$ZENHOME' is not set.
    echo This is usually caused by executing this command as root rather than \
as the zenoss user.  Either define '$ZENHOME' or run this command as a \
different user.
    exit 1
fi

RRDCACHED_ADDRESS=$ZENHOME/var/rrdcached.sock
JOURNALDIR=$ZENHOME/var/rrd_journals
PIDFILE=$ZENHOME/var/rrdcached.pid

if [ -z "$RRDCACHED" ]; then
    RRDCACHED=`which rrdcached`
fi

if [ ! -f "$RRDCACHED" ]; then
    echo rrdcached could not be found in '$RRDCACHED' or in the path.  Ensure \
that rrdcached is in the path or define '$RRDCACHED'.
    exit 1
fi

stats() { 
    $ZENHOME/bin/python $ZENHOME/Products/ZenRRD/zenrrdcached_util.py stats 
} 


running() {
    if [ -f $PIDFILE ]; then
        PID=`cat $PIDFILE 2>/dev/null`
        if [ -n "$PID" ]; then
            kill -0 $PID 2>/dev/null || ps -p "$PID" > /dev/null 2>&1
            return $?
        fi
    fi
    return 1
}

start() {
    if running; then
        echo is already running
    else
        echo starting...
        "$RRDCACHED" -p $PIDFILE -l $RRDCACHED_ADDRESS -j $JOURNALDIR $OPTS
    fi
}

run() {
    export OPTS="-g $OPTS"
    start
}

stop() {
    echo "stopping..."
    if running; then
        kill `cat $PIDFILE`
    else
        echo "already stopped"
    fi
}

restart() {
    stop
    start
}

status() {
    if running; then
        echo "program running; pid=`cat $PIDFILE`"
    else
        echo "not running"
    fi
}

usage() {
    echo "Usage: zenrrdcached [run|start|restart|stop|status|stats] [options]"
}


ACTION=$1
shift
export OPTS="$@"
mkdir -p $JOURNALDIR
$ACTION || usage
