#! /usr/bin/env bash

#
# zenoss_upgrade_pre
#
# This script is intended to be run before the zenoss processes have
# been started for the first time after an upgrade.
#
# Note: it is run by root
#

#############################################################################
# This program is part of Zenoss Core, an open source monitoring platform.
# Copyright (C) 2007, Zenoss Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 as published by
# the Free Software Foundation.
#
# For complete information please visit: http://www.zenoss.com/oss/
#############################################################################
# environment variables

# load startup parameters
. ${ZENHOME}/bin/zenoss_startup_config

# load the installation functions
. ${ZENHOME}/bin/shared-functions.sh
. ${ZENHOME}/bin/install-functions.sh

# Confirm Sun/Oracle flavored jre
confirm_jre

# copy the etc/*.conf.example files to etc/*.conf if etc/*.conf don't
# already exist (we don't want to clobber people's configs)
update_conf_files

# version 2.1.1 and below used the system python, but in 2.1.70 we
# started shipping our own.  replace the old scripts with references
# to the new python

# zenstatus was updated in Avalon to remove the command-line
# option 'configpath'
sed -i -e 's/[ \t]*configpath .*//' $ZENHOME/etc/zenstatus.conf

# set the python shebang to be the proper python
shebang

# restart external server daemons
restart_snmpd
if [ "${ZODB_HOST}" = "localhost" ];then
    start_mysql
fi
start_rabbitmq

# Update AMQP configuration files
configure_amqp

# patch any ZenPack code that isn't compatible with this version of core
. ${ZENHOME}/bin/zenoss_upgrade_patch_zenpacks.sh

# create the ZEP database
create_zep_db

# TODO: Migrate ZEP database

# Remove previous ZEP configuration settings
remove_zep_jdbc_config

# Move from ZODB to MySQL
#TODO: changeObjectStore needs to be ported
#${ZENHOME}/bin/python ${ZENHOME}/bin/changeObjectStore.py \
#    2>&1 | egrep -v "For help, use ${ZENHOME}/bin/zeoctl -h|Error: no program specified; use -p or -C"

# update/migrate zodb
create_zodb_db
create_zodb_session_db

# Patch zopectl and runzope to accept config files
patch_zopectl_and_runzope

# Upgrade to persistent sessions if necessary
upgrade_to_persistent_sessions

# migrate the zeo database
run_zenmigrate

