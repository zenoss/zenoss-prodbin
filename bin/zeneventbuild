#! /usr/bin/env bash
#############################################################################
# This program is part of Zenoss Core, an open source monitoring platform.
# Copyright (C) 2007, Zenoss Inc.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 as published by
# the Free Software Foundation.
#
# For complete information please visit: http://www.zenoss.com/oss/
#############################################################################

if [ "$ZENHOME" = "" ]; then 
    echo ERROR: ZENHOME envrionment variable not set.
    exit 1
fi

EVTDB=$ZENHOME/Products/ZenEvents/db

if [ -d $EVTDB ]; then 
    cd $EVTDB
else
    echo ERROR: $EVTDB not installed. 
    exit 1
fi

MYSQLHOST=$1
MYSQLUSER=$2
MYSQLPASS=$3
MYSQLDB=$4
MYSQLPORT=$5
if [ -z "$MYSQLPORT" ] ; then
   MYSQLPORT=3306
fi

# Create the database
echo "creating database" >&2
echo "CREATE DATABASE IF NOT EXISTS $MYSQLDB" | \
mysql -h $MYSQLHOST -u $MYSQLUSER --password=$MYSQLPASS --port=$MYSQLPORT

echo "dropping any triggers that my already exist" >&2
echo "DROP TRIGGER status_delete"  | \
mysql -h $MYSQLHOST -u $MYSQLUSER --password=$MYSQLPASS --port=$MYSQLPORT $MYSQLDB 2>/dev/null

# Load schema
echo "loading schema" >&2
mysql -h $MYSQLHOST -u $MYSQLUSER --password=$MYSQLPASS --port=$MYSQLPORT $MYSQLDB < zenevents.sql

# Load stored procedures
echo "loading stored procedures" >&2
mysql -h $MYSQLHOST -u $MYSQLUSER --password=$MYSQLPASS --port=$MYSQLPORT $MYSQLDB < zenprocs.sql
echo "events database created and loaded" >&2
